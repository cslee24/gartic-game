<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦´ë ˆì´ ê·¸ë¦¼ & ì¶”ì¸¡ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #drawingCanvas {
            border: 2px solid #3b82f6;
            cursor: crosshair;
            touch-action: none;
            background-color: white;
        }
        .step-card {
            background-color: #f3f4f6;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-700">ë¦´ë ˆì´ ê·¸ë¦¼ & ì¶”ì¸¡ ê²Œì„</h1>
            <p class="text-gray-500 mt-2">ê¸€ë¡œ ì‹œì‘í•´ì„œ ê·¸ë¦¼ìœ¼ë¡œ, ê·¸ë¦¼ì—ì„œ ê¸€ë¡œ ì´ì–´ì§€ëŠ” ë¦´ë ˆì´ í€´ì¦ˆ</p>
        </header>

        <!-- ë©”ì‹œì§€ ë°•ìŠ¤ -->
        <div id="messageBox" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg shadow mb-6 hidden">
            <p id="messageText" class="font-medium"></p>
        </div>

        <div id="content" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
            
            <!-- ì—°ê²° ìƒíƒœ -->
            <div id="connectionStatus" class="text-center mb-4">
                <span id="statusIndicator" class="inline-block w-3 h-3 rounded-full bg-yellow-500 mr-2"></span>
                <span id="statusText" class="text-gray-600">ì„œë²„ ì—°ê²° ì¤‘...</span>
            </div>

            <!-- ë°© ì„ íƒ/ìƒì„± ë·° -->
            <div id="roomSelectionView" class="hidden text-center">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">ë°© ì„ íƒ</h2>

                <div class="mb-8 p-6 border-2 border-blue-200 rounded-xl bg-blue-50 shadow-md">
                    <h3 class="text-xl font-semibold mb-3 text-blue-700">ë°© ë§Œë“¤ê¸°</h3>
                    <button id="createRoomBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150 shadow-lg">
                        ìƒˆë¡œìš´ ë°© ë§Œë“¤ê¸°
                    </button>
                </div>

                <div class="p-6 border-2 border-gray-300 rounded-xl bg-white shadow-md">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">ë°© ì°¸ì—¬</h3>
                    <input type="text" id="joinRoomIdInput" placeholder="ë°© ID (ì˜ˆ: ABC123)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 mb-2 uppercase">
                    <button id="joinRoomBtn" class="w-full bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition duration-150 shadow-lg" disabled>
                        ë°© ì°¸ì—¬í•˜ê¸°
                    </button>
                </div>
            </div>

            <!-- ë¡œë¹„ ë·° -->
            <div id="lobbyView" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">ê²Œì„ ë¡œë¹„</h2>
                
                <div class="mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200 shadow-inner">
                    <p class="font-semibold text-indigo-700 mb-2">ë°© ID: <span id="roomIdDisplay" class="font-mono bg-indigo-200 px-2 py-1 rounded text-lg"></span></p>
                    <input type="text" id="roomLinkInput" class="w-full p-2 border border-indigo-300 rounded-lg bg-white text-sm mt-2" readonly>
                    <button id="copyLinkBtn" class="mt-2 w-full bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                        ğŸ”— ì°¸ì—¬ ë§í¬ ë³µì‚¬
                    </button>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë‹‰ë„¤ì„ ì„¤ì •:</label>
                    <input type="text" id="userNameInput" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <button id="setUserNameBtn" class="mt-2 w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">ë‹‰ë„¤ì„ ì €ì¥ & ì¤€ë¹„ ì™„ë£Œ</button>
                </div>

                <h3 class="text-xl font-semibold mb-2">ì°¸ê°€ì (<span id="userCount">0</span>ëª…)</h3>
                <ul id="userList" class="space-y-2 mb-6 p-3 bg-gray-50 rounded-lg max-h-40 overflow-y-auto"></ul>

                <button id="startGameBtn" class="w-full bg-green-500 text-white p-4 text-lg rounded-xl hover:bg-green-600 transition duration-150 shadow-lg" disabled>
                    ê²Œì„ ì‹œì‘ (ìµœì†Œ 2ëª… í•„ìš”)
                </button>
            </div>

            <!-- í”„ë¡¬í”„íŠ¸ ì…ë ¥ -->
            <div id="promptView" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">1ë‹¨ê³„: ì²« ë¬¸ì¥ ì“°ê¸°</h2>
                <p class="mb-4 text-gray-600">ì¬ë¯¸ìˆëŠ” ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”!</p>
                <textarea id="initialPromptInput" rows="3" class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-blue-500 focus:border-blue-500" placeholder="ì˜ˆ: ìš°ì£¼ë³µì„ ì…ì€ ê³ ì–‘ì´ê°€ í”¼ìë¥¼ êµ½ê³  ìˆë‹¤"></textarea>
                <button id="submitPromptBtn" class="mt-4 w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md" disabled>ë¬¸ì¥ ì œì¶œ</button>
            </div>

            <!-- ê²Œì„ í”Œë ˆì´ -->
            <div id="gameView" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800"><span id="roundTitle"></span></h2>
                <div id="taskDescription" class="mb-4 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400"></div>

                <!-- ê·¸ë¦¼ ê·¸ë¦¬ê¸° -->
                <div id="drawingTask" class="hidden">
                    <p class="text-lg font-semibold mb-2">ê·¸ë ¤ì•¼ í•  ë¬¸ì¥:</p>
                    <p id="textToDraw" class="mb-4 p-3 bg-gray-100 rounded-lg text-xl font-medium text-center"></p>

                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="color" id="colorPicker" value="#000000" class="w-12 h-12 rounded-full border-2 border-gray-300">
                        <input type="range" id="brushSize" min="2" max="30" value="5" class="w-full sm:w-1/3">
                        <span id="brushSizeDisplay" class="font-mono text-gray-600 self-center">5px</span>
                        <button id="clearCanvasBtn" class="flex-grow bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-150 shadow-md">ì§€ìš°ê¸°</button>
                    </div>

                    <canvas id="drawingCanvas" class="w-full rounded-lg shadow-inner"></canvas>
                    <button id="submitDrawingBtn" class="mt-4 w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">ê·¸ë¦¼ ì œì¶œ</button>
                </div>

                <!-- ì¶”ì¸¡í•˜ê¸° -->
                <div id="guessingTask" class="hidden">
                    <p class="text-lg font-semibold mb-2">ë¬´ì—‡ì„ ê·¸ë¦° ê±¸ê¹Œìš”?</p>
                    <div id="imageToGuessContainer" class="mb-4 flex justify-center p-4 bg-gray-100 rounded-lg">
                        <img id="imageToGuess" class="max-w-full h-auto rounded-lg border border-gray-300" alt="ì¶”ì¸¡í•´ì•¼ í•  ê·¸ë¦¼">
                    </div>
                    <textarea id="guessInput" rows="2" class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-blue-500 focus:border-blue-500" placeholder="ì´ ê·¸ë¦¼ì´ ë¬´ì—‡ì¸ì§€ ì¶”ì¸¡í•˜ì„¸ìš”"></textarea>
                    <button id="submitGuessBtn" class="mt-4 w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">ì¶”ì¸¡ ì œì¶œ</button>
                </div>

                <!-- ëŒ€ê¸° -->
                <div id="waitingMessage" class="hidden text-center p-8 bg-indigo-50 rounded-lg border-2 border-indigo-200">
                    <p class="text-xl font-bold text-indigo-700">ì œì¶œ ì™„ë£Œ! ë‹¤ë¥¸ í”Œë ˆì´ì–´ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
                    <div class="mt-4">
                        <svg class="animate-pulse h-6 w-6 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- ê²°ê³¼ ë°œí‘œ -->
            <div id="revealView" class="hidden">
                <h2 class="text-3xl font-bold mb-6 text-green-700 text-center">ğŸ‰ ê²Œì„ ê²°ê³¼ ë°œí‘œ ğŸ‰</h2>
                <div id="revealContainer" class="space-y-8"></div>
                <div class="mt-8 text-center">
                    <button id="newGameBtn" class="bg-indigo-500 text-white p-3 rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">ìƒˆ ê²Œì„ ì‹œì‘</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ğŸ”§ ì„¤ì • - Render ë°°í¬ í›„ ì´ URLì„ ë³€ê²½í•˜ì„¸ìš”!
        // ============================================
        const WS_SERVER_URL = 'wss://your-render-app-name.onrender.com';
        // ë¡œì»¬ í…ŒìŠ¤íŠ¸: 'ws://localhost:3000'
        // ============================================

        // ì „ì—­ ë³€ìˆ˜
        let ws = null;
        let userId = localStorage.getItem('gartic_userId') || generateUserId();
        let roomId = null;
        let currentRoom = null;
        let targetBookStarterId = null;

        // ìº”ë²„ìŠ¤ ë³€ìˆ˜
        let canvas, ctx;
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let currentColor = '#000000';
        let currentBrushSize = 5;

        // ìœ ì € ID ìƒì„± ë° ì €ì¥
        function generateUserId() {
            const id = 'user_' + Math.random().toString(36).substring(2, 11);
            localStorage.setItem('gartic_userId', id);
            return id;
        }

        // DOM ìš”ì†Œ
        const elements = {
            messageBox: document.getElementById('messageBox'),
            messageText: document.getElementById('messageText'),
            statusIndicator: document.getElementById('statusIndicator'),
            statusText: document.getElementById('statusText'),
            roomSelectionView: document.getElementById('roomSelectionView'),
            lobbyView: document.getElementById('lobbyView'),
            promptView: document.getElementById('promptView'),
            gameView: document.getElementById('gameView'),
            revealView: document.getElementById('revealView'),
            roomIdDisplay: document.getElementById('roomIdDisplay'),
            roomLinkInput: document.getElementById('roomLinkInput'),
            userNameInput: document.getElementById('userNameInput'),
            userList: document.getElementById('userList'),
            userCount: document.getElementById('userCount'),
            startGameBtn: document.getElementById('startGameBtn'),
            initialPromptInput: document.getElementById('initialPromptInput'),
            submitPromptBtn: document.getElementById('submitPromptBtn'),
            roundTitle: document.getElementById('roundTitle'),
            taskDescription: document.getElementById('taskDescription'),
            drawingTask: document.getElementById('drawingTask'),
            guessingTask: document.getElementById('guessingTask'),
            waitingMessage: document.getElementById('waitingMessage'),
            textToDraw: document.getElementById('textToDraw'),
            imageToGuess: document.getElementById('imageToGuess'),
            guessInput: document.getElementById('guessInput'),
            revealContainer: document.getElementById('revealContainer')
        };

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(msg, type = 'info') {
            const colors = {
                info: 'bg-blue-100 border-blue-500 text-blue-700',
                error: 'bg-red-100 border-red-500 text-red-700',
                success: 'bg-green-100 border-green-500 text-green-700',
                warning: 'bg-yellow-100 border-yellow-500 text-yellow-700'
            };
            elements.messageBox.className = `p-4 rounded-lg shadow mb-6 border-l-4 ${colors[type]}`;
            elements.messageText.textContent = msg;
            elements.messageBox.classList.remove('hidden');
        }

        // ë·° ì „í™˜
        function showView(viewId) {
            ['roomSelectionView', 'lobbyView', 'promptView', 'gameView', 'revealView'].forEach(v => {
                elements[v].classList.add('hidden');
            });
            if (viewId && elements[viewId]) {
                elements[viewId].classList.remove('hidden');
            }
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(connected) {
            elements.statusIndicator.className = `inline-block w-3 h-3 rounded-full mr-2 ${connected ? 'bg-green-500' : 'bg-red-500'}`;
            elements.statusText.textContent = connected ? 'ì„œë²„ ì—°ê²°ë¨' : 'ì„œë²„ ì—°ê²° ëŠê¹€';
        }

        // WebSocket ì—°ê²°
        function connectWebSocket() {
            ws = new WebSocket(WS_SERVER_URL);

            ws.onopen = () => {
                console.log('WebSocket ì—°ê²°ë¨');
                updateConnectionStatus(true);
                
                // URLì—ì„œ ë°© ID í™•ì¸
                const urlParams = new URLSearchParams(window.location.search);
                const urlRoomId = urlParams.get('room');
                
                if (urlRoomId) {
                    joinRoom(urlRoomId);
                } else {
                    showView('roomSelectionView');
                }
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleServerMessage(message);
            };

            ws.onclose = () => {
                console.log('WebSocket ì—°ê²° ëŠê¹€');
                updateConnectionStatus(false);
                setTimeout(connectWebSocket, 3000); // ì¬ì—°ê²° ì‹œë„
            };

            ws.onerror = (error) => {
                console.error('WebSocket ì˜¤ë¥˜:', error);
                showMessage('ì„œë²„ ì—°ê²° ì˜¤ë¥˜. ì¬ì—°ê²° ì‹œë„ ì¤‘...', 'error');
            };
        }

        // ì„œë²„ ë©”ì‹œì§€ ì²˜ë¦¬
        function handleServerMessage(message) {
            const { type, payload } = message;

            switch (type) {
                case 'ROOM_CREATED':
                    roomId = payload.roomId;
                    currentRoom = payload.room;
                    window.history.pushState({}, '', `?room=${roomId}`);
                    updateLobby();
                    showView('lobbyView');
                    showMessage(`ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${roomId}`, 'success');
                    break;

                case 'ROOM_UPDATE':
                    currentRoom = payload.room;
                    handleRoomUpdate();
                    break;

                case 'ERROR':
                    showMessage(payload.message, 'error');
                    break;
            }
        }

        // ë°© ìƒíƒœ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
        function handleRoomUpdate() {
            if (!currentRoom) return;

            switch (currentRoom.state) {
                case 'lobby':
                    updateLobby();
                    showView('lobbyView');
                    break;
                case 'prompt':
                    handlePromptState();
                    showView('promptView');
                    break;
                case 'drawing':
                case 'guessing':
                    handleGameState();
                    showView('gameView');
                    break;
                case 'reveal':
                    renderReveal();
                    showView('revealView');
                    break;
            }
        }

        // ë¡œë¹„ ì—…ë°ì´íŠ¸
        function updateLobby() {
            elements.roomIdDisplay.textContent = roomId;
            elements.roomLinkInput.value = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
            
            elements.userCount.textContent = currentRoom.users.length;
            elements.userList.innerHTML = '';
            
            currentRoom.users.forEach(user => {
                const li = document.createElement('li');
                const isMe = user.id === userId;
                const isHost = user.id === currentRoom.hostId;
                li.className = `p-2 rounded-lg flex justify-between items-center ${isMe ? 'bg-blue-50' : 'bg-white'}`;
                li.innerHTML = `
                    <span class="font-semibold">${user.name} ${isMe ? '(ë‚˜)' : ''} ${isHost ? 'ğŸ‘‘' : ''}</span>
                    <span class="text-sm ${user.isReady ? 'text-green-600' : 'text-gray-400'}">${user.isReady ? 'âœ… ì¤€ë¹„' : 'â³ ëŒ€ê¸°'}</span>
                `;
                elements.userList.appendChild(li);
            });

            const isHost = currentRoom.hostId === userId;
            const allReady = currentRoom.users.every(u => u.isReady);
            elements.startGameBtn.disabled = !isHost || currentRoom.users.length < 2 || !allReady;
            elements.startGameBtn.textContent = isHost ? 'ê²Œì„ ì‹œì‘' : 'ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤';
        }

        // í”„ë¡¬í”„íŠ¸ ìƒíƒœ ì²˜ë¦¬
        function handlePromptState() {
            const hasSubmitted = currentRoom.books.some(b => b.starterId === userId);
            elements.submitPromptBtn.disabled = hasSubmitted;
            elements.initialPromptInput.disabled = hasSubmitted;
            
            if (hasSubmitted) {
                showMessage('ë¬¸ì¥ ì œì¶œ ì™„ë£Œ! ë‹¤ë¥¸ í”Œë ˆì´ì–´ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...', 'info');
            }
        }

        // ê²Œì„ ìƒíƒœ ì²˜ë¦¬
        function handleGameState() {
            const userIds = currentRoom.users.map(u => u.id);
            const userIndex = userIds.indexOf(userId);
            
            // ë‚´ê°€ ì‘ì—…í•´ì•¼ í•  ì±… ì°¾ê¸°
            const targetIndex = (userIndex - currentRoom.currentRound + userIds.length) % userIds.length;
            targetBookStarterId = userIds[targetIndex];
            const targetBook = currentRoom.books.find(b => b.starterId === targetBookStarterId);

            if (!targetBook) {
                showMessage('í• ë‹¹ëœ ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const lastEntry = targetBook.chain[targetBook.chain.length - 1];
            const alreadySubmitted = targetBook.chain.length >= currentRoom.currentRound + 1;

            elements.roundTitle.textContent = `${currentRoom.currentRound}ë¼ìš´ë“œ: ${currentRoom.state === 'drawing' ? 'ê·¸ë¦¼ ê·¸ë¦¬ê¸°' : 'ì¶”ì¸¡í•˜ê¸°'}`;
            
            const starterUser = currentRoom.users.find(u => u.id === targetBook.starterId);
            elements.taskDescription.innerHTML = `
                <p class="font-bold">${starterUser ? starterUser.name : 'ì•Œ ìˆ˜ ì—†ìŒ'}ë‹˜ì´ ì‹œì‘í•œ ì´ì•¼ê¸°</p>
            `;

            // ëª¨ë“  íƒœìŠ¤í¬ ìˆ¨ê¸°ê¸°
            elements.drawingTask.classList.add('hidden');
            elements.guessingTask.classList.add('hidden');
            elements.waitingMessage.classList.add('hidden');

            if (alreadySubmitted) {
                elements.waitingMessage.classList.remove('hidden');
                showMessage('ì œì¶œ ì™„ë£Œ! ë‹¤ë¥¸ í”Œë ˆì´ì–´ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...', 'info');
                return;
            }

            if (currentRoom.state === 'drawing') {
                elements.drawingTask.classList.remove('hidden');
                elements.textToDraw.textContent = `"${lastEntry.content}"`;
                setupCanvas();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                showMessage('ìœ„ ë¬¸ì¥ì„ ë³´ê³  ê·¸ë¦¼ì„ ê·¸ë¦¬ì„¸ìš”!', 'warning');
            } else {
                elements.guessingTask.classList.remove('hidden');
                elements.imageToGuess.src = lastEntry.content;
                showMessage('ì´ ê·¸ë¦¼ì´ ë¬´ì—‡ì¸ì§€ ì¶”ì¸¡í•˜ì„¸ìš”!', 'warning');
            }
        }

        // ê²°ê³¼ ë Œë”ë§
        function renderReveal() {
            elements.revealContainer.innerHTML = '';
            
            currentRoom.books.forEach(book => {
                const starter = currentRoom.users.find(u => u.id === book.starterId);
                const bookDiv = document.createElement('div');
                bookDiv.className = 'p-6 border-2 border-gray-200 rounded-xl shadow-lg';
                bookDiv.innerHTML = `<h3 class="text-2xl font-bold mb-4 text-purple-700">ğŸ“š ${starter ? starter.name : 'ì•Œ ìˆ˜ ì—†ìŒ'}ë‹˜ì˜ ì´ì•¼ê¸°</h3>`;

                book.chain.forEach((entry, index) => {
                    const creator = currentRoom.users.find(u => u.id === entry.creatorId);
                    const card = document.createElement('div');
                    card.className = 'step-card';

                    if (entry.type === 'text') {
                        card.innerHTML = `
                            <p class="font-semibold text-gray-700">Step ${index + 1}. ë¬¸ì¥ (${creator ? creator.name : 'ì•Œ ìˆ˜ ì—†ìŒ'})</p>
                            <p class="text-xl mt-1 italic">"${entry.content}"</p>
                        `;
                    } else {
                        card.innerHTML = `
                            <p class="font-semibold text-gray-700">Step ${index + 1}. ê·¸ë¦¼ (${creator ? creator.name : 'ì•Œ ìˆ˜ ì—†ìŒ'})</p>
                            <img src="${entry.content}" class="mt-2 max-w-full h-auto rounded-lg border">
                        `;
                    }
                    bookDiv.appendChild(card);
                });
                
                elements.revealContainer.appendChild(bookDiv);
            });
        }

        // ìº”ë²„ìŠ¤ ì„¤ì •
        function setupCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');

            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width - 4;
            canvas.height = Math.min(rect.width * 0.75, 400);

            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = currentBrushSize;
                ctx.stroke();
                [lastX, lastY] = [pos.x, pos.y];
            };

            const startDrawing = (e) => {
                e.preventDefault();
                isDrawing = true;
                const pos = getPos(e);
                [lastX, lastY] = [pos.x, pos.y];
            };

            const stopDrawing = () => isDrawing = false;

            canvas.onmousedown = startDrawing;
            canvas.onmousemove = draw;
            canvas.onmouseup = stopDrawing;
            canvas.onmouseout = stopDrawing;
            canvas.ontouchstart = startDrawing;
            canvas.ontouchmove = draw;
            canvas.ontouchend = stopDrawing;
        }

        // ë°© ìƒì„±
        function createRoom() {
            ws.send(JSON.stringify({
                type: 'CREATE_ROOM',
                payload: { userId }
            }));
        }

        // ë°© ì°¸ì—¬
        function joinRoom(id) {
            roomId = id;
            ws.send(JSON.stringify({
                type: 'JOIN_ROOM',
                payload: { roomId: id, userId }
            }));
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('createRoomBtn').onclick = createRoom;
        
        document.getElementById('joinRoomBtn').onclick = () => {
            const id = document.getElementById('joinRoomIdInput').value.trim().toUpperCase();
            if (id) joinRoom(id);
        };

        document.getElementById('joinRoomIdInput').oninput = (e) => {
            e.target.value = e.target.value.toUpperCase();
            document.getElementById('joinRoomBtn').disabled = !e.target.value.trim();
        };

        document.getElementById('copyLinkBtn').onclick = () => {
            navigator.clipboard.writeText(elements.roomLinkInput.value)
                .then(() => showMessage('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success'))
                .catch(() => showMessage('ë³µì‚¬ ì‹¤íŒ¨', 'error'));
        };

        document.getElementById('setUserNameBtn').onclick = () => {
            const name = elements.userNameInput.value.trim();
            if (name) {
                ws.send(JSON.stringify({
                    type: 'SET_USERNAME',
                    payload: { userName: name }
                }));
            }
        };

        elements.startGameBtn.onclick = () => {
            ws.send(JSON.stringify({ type: 'START_GAME', payload: {} }));
        };

        elements.initialPromptInput.oninput = (e) => {
            elements.submitPromptBtn.disabled = !e.target.value.trim();
        };

        elements.submitPromptBtn.onclick = () => {
            const prompt = elements.initialPromptInput.value.trim();
            if (prompt) {
                ws.send(JSON.stringify({
                    type: 'SUBMIT_PROMPT',
                    payload: { prompt }
                }));
            }
        };

        document.getElementById('colorPicker').oninput = (e) => currentColor = e.target.value;
        document.getElementById('brushSize').oninput = (e) => {
            currentBrushSize = parseInt(e.target.value);
            document.getElementById('brushSizeDisplay').textContent = `${currentBrushSize}px`;
        };
        document.getElementById('clearCanvasBtn').onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

        document.getElementById('submitDrawingBtn').onclick = () => {
            const drawing = canvas.toDataURL('image/png');
            ws.send(JSON.stringify({
                type: 'SUBMIT_DRAWING',
                payload: { drawing, targetStarterId: targetBookStarterId }
            }));
        };

        elements.guessInput.oninput = (e) => {
            document.getElementById('submitGuessBtn').disabled = !e.target.value.trim();
        };

        document.getElementById('submitGuessBtn').onclick = () => {
            const guess = elements.guessInput.value.trim();
            if (guess) {
                ws.send(JSON.stringify({
                    type: 'SUBMIT_GUESS',
                    payload: { guess, targetStarterId: targetBookStarterId }
                }));
                elements.guessInput.value = '';
            }
        };

        document.getElementById('newGameBtn').onclick = () => {
            ws.send(JSON.stringify({ type: 'NEW_GAME', payload: {} }));
        };

        // ì‹œì‘
        connectWebSocket();
    </script>
</body>
</html>
