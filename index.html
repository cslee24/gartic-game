<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦´ë ˆì´ ê·¸ë¦¼ & ì¶”ì¸¡ ê²Œì„ (Gartic Style)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (ê¹”ë”í•œ í°íŠ¸) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* ìº”ë²„ìŠ¤ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        #drawingCanvas {
            border: 2px solid #3b82f6;
            cursor: crosshair;
            touch-action: none; /* í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ë¥¼ ìœ„í•´ ê¸°ë³¸ ìŠ¤í¬ë¡¤ ë™ì‘ ë°©ì§€ */
            background-color: white;
        }
        .step-card {
            background-color: #f3f4f6;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-700">ë¦´ë ˆì´ ê·¸ë¦¼ & ì¶”ì¸¡ ê²Œì„</h1>
            <p class="text-gray-500 mt-2">ê¸€ë¡œ ì‹œì‘í•´ì„œ ê·¸ë¦¼ìœ¼ë¡œ, ê·¸ë¦¼ì—ì„œ ê¸€ë¡œ ì´ì–´ì§€ëŠ” ë¦´ë ˆì´ í€´ì¦ˆ ê²Œì„</p>
        </header>

        <!-- ë¡œë”© ë° ì˜¤ë¥˜ ë©”ì‹œì§€ -->
        <div id="messageBox" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow mb-6 hidden">
            <p id="messageText" class="font-medium">ë¡œë”© ì¤‘...</p>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <div id="content" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
            <!-- ì¸ì¦ ë° ì´ˆê¸°í™” ìƒíƒœ -->
            <div id="initStatus" class="text-center">
                <p class="text-lg text-gray-600">ê²Œì„ ë°ì´í„° ì´ˆê¸°í™” ë° ì¸ì¦ ì¤‘...</p>
                <div class="mt-4"><svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
            </div>

            <!-- ë°© ì„ íƒ/ìƒì„± ë·° (New) -->
            <div id="roomSelectionView" class="hidden text-center">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">ë°© ì„ íƒ</h2>

                <!-- ë°© ìƒì„± -->
                <div class="mb-8 p-6 border-2 border-blue-200 rounded-xl bg-blue-50 shadow-md">
                    <h3 class="text-xl font-semibold mb-3 text-blue-700">ë°© ë§Œë“¤ê¸° (ë°©ì¥)</h3>
                    <button id="createRoomBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150 shadow-lg">
                        ìƒˆë¡œìš´ ë°© ë§Œë“¤ê¸°
                    </button>
                </div>

                <!-- ë°© ì°¸ì—¬ -->
                <div class="p-6 border-2 border-gray-300 rounded-xl bg-white shadow-md">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">ë°© ì°¸ì—¬</h3>
                    <input type="text" id="joinRoomIdInput" placeholder="ì°¸ì—¬í•  ë°© ID (ì˜ˆ: 1234)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 mb-2">
                    <button id="joinRoomBtn" class="w-full bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition duration-150 shadow-lg" disabled>
                        ë°© ì°¸ì—¬í•˜ê¸°
                    </button>
                </div>
            </div>

            <!-- ê²Œì„ ë¡œë¹„ ë° ì‹œì‘ í™”ë©´ -->
            <div id="lobbyView" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">ê²Œì„ ë¡œë¹„</h2>
                
                <!-- ë°© ì •ë³´ ë° ë§í¬ ê³µìœ  -->
                <div class="mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200 shadow-inner">
                    <p class="font-semibold text-indigo-700 mb-2">í˜„ì¬ ë°© ID: <span id="roomIdDisplay" class="font-mono bg-indigo-200 px-2 py-1 rounded text-lg"></span></p>
                    <p class="text-sm text-gray-500 mb-2">ì‚¬ìš©ì ID: <span id="userIdDisplay" class="font-mono text-xs"></span></p>

                    <div id="linkShareSection" class="mt-3">
                        <input type="text" id="roomLinkInput" class="w-full p-2 border border-indigo-300 rounded-lg bg-white text-sm" readonly>
                        <button id="copyLinkBtn" class="mt-2 w-full bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                            ğŸ”— ì°¸ì—¬ ë§í¬ ë³µì‚¬
                        </button>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="userNameInput" class="block text-sm font-medium text-gray-700 mb-1">ë‹‰ë„¤ì„ ì„¤ì •:</label>
                    <input type="text" id="userNameInput" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <button id="setUserNameBtn" class="mt-2 w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">ë‹‰ë„¤ì„ ì €ì¥</button>
                </div>

                <h3 class="text-xl font-semibold mb-2">ì°¸ê°€ì (<span id="userCount">0</span>ëª…)</h3>
                <ul id="userList" class="space-y-2 mb-6 p-3 bg-gray-50 rounded-lg max-h-40 overflow-y-auto">
                    <!-- ì°¸ê°€ì ëª©ë¡ -->
                </ul>

                <button id="startGameBtn" class="w-full bg-green-500 text-white p-4 text-lg rounded-xl hover:bg-green-600 transition duration-150 shadow-lg" disabled>
                    ê²Œì„ ì‹œì‘ (ë°©ì¥ ì „ìš©)
                </button>
            </div>

            <!-- í”„ë¡¬í”„íŠ¸ ì…ë ¥ ë‹¨ê³„ -->
            <div id="promptView" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">1ë‹¨ê³„: ì²« ë¬¸ì¥ ì“°ê¸°</h2>
                <p class="mb-4 text-gray-600">ì¬ë¯¸ìˆê³  ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ê²°ê³¼ë¥¼ ë§Œë“¤ ìˆ˜ ìˆëŠ” ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
                <textarea id="initialPromptInput" rows="3" class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-blue-500 focus:border-blue-500" placeholder="ì˜ˆ: ìš°ì£¼ë³µì„ ì…ì€ ê³ ì–‘ì´ê°€ í”¼ìë¥¼ êµ½ê³  ìˆë‹¤"></textarea>
                <button id="submitPromptBtn" class="mt-4 w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md" disabled>ë¬¸ì¥ ì œì¶œ</button>
            </div>

            <!-- ê²Œì„ í”Œë ˆì´ ë‹¨ê³„ (ê·¸ë¦¼ ë˜ëŠ” ì¶”ì¸¡) -->
            <div id="gameView" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800"><span id="roundTitle"></span></h2>
                <div id="taskDescription" class="mb-4 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
                    <!-- í˜„ì¬ ë¼ìš´ë“œì˜ ì‘ì—… ë‚´ìš© í‘œì‹œ -->
                </div>

                <!-- ê·¸ë¦¼ ê·¸ë¦¬ê¸° ì˜ì—­ -->
                <div id="drawingTask" class="hidden">
                    <p class="text-lg font-semibold mb-2">ê·¸ë ¤ì•¼ í•  ë¬¸ì¥:</p>
                    <p id="textToDraw" class="mb-4 p-3 bg-gray-100 rounded-lg text-xl font-medium text-center"></p>

                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="color" id="colorPicker" value="#000000" class="w-12 h-12 rounded-full border-2 border-gray-300">
                        <input type="range" id="brushSize" min="2" max="30" value="5" class="w-full sm:w-1/3">
                        <span id="brushSizeDisplay" class="font-mono text-gray-600 self-center">5px</span>
                        <button id="clearCanvasBtn" class="flex-grow bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-150 shadow-md">ì§€ìš°ê¸°</button>
                    </div>

                    <canvas id="drawingCanvas" class="w-full rounded-lg shadow-inner"></canvas>
                    <button id="submitDrawingBtn" class="mt-4 w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md" disabled>ê·¸ë¦¼ ì œì¶œ</button>
                </div>

                <!-- ì¶”ì¸¡ ì…ë ¥ ì˜ì—­ -->
                <div id="guessingTask" class="hidden">
                    <p class="text-lg font-semibold mb-2">ë¬´ì—‡ì„ ê·¸ë¦° ê±¸ê¹Œìš”?</p>
                    <div id="imageToGuessContainer" class="mb-4 flex justify-center p-4 bg-gray-100 rounded-lg">
                        <img id="imageToGuess" class="max-w-full h-auto rounded-lg border border-gray-300" alt="ì¶”ì¸¡í•´ì•¼ í•  ê·¸ë¦¼">
                    </div>
                    <textarea id="guessInput" rows="2" class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-blue-500 focus:border-blue-500" placeholder="ì´ ê·¸ë¦¼ì´ ë¬´ì—‡ì¸ì§€ ì¶”ì¸¡í•˜ì—¬ ë¬¸ì¥ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                    <button id="submitGuessBtn" class="mt-4 w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition duration-150 shadow-md" disabled>ì¶”ì¸¡ ì œì¶œ</button>
                </div>

                <!-- ëŒ€ê¸° ì¤‘ ë©”ì‹œì§€ -->
                <div id="waitingMessage" class="hidden text-center p-8 bg-indigo-50 rounded-lg border-2 border-indigo-200">
                    <p class="text-xl font-bold text-indigo-700">ì œì¶œ ì™„ë£Œ! ë‹¤ë¥¸ í”Œë ˆì´ì–´ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
                    <div class="mt-4"><svg class="animate-pulse h-6 w-6 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                </div>

            </div>

            <!-- ê²°ê³¼ ë°œí‘œ ë‹¨ê³„ -->
            <div id="revealView" class="hidden">
                <h2 class="text-3xl font-bold mb-6 text-green-700 text-center">ğŸ‰ ê²Œì„ ê²°ê³¼ ë°œí‘œ ğŸ‰</h2>
                <div id="revealContainer" class="space-y-8">
                    <!-- ë¦´ë ˆì´ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤. -->
                </div>
                <div class="mt-8 text-center">
                    <button id="newGameBtn" class="bg-indigo-500 text-white p-3 rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">ìƒˆ ê²Œì„ ì‹œì‘</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, runTransaction, getDoc, arrayUnion, arrayRemove, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore ë¡œê¹… ì„¤ì • (ë””ë²„ê¹…ìš©)
        setLogLevel('Debug');

        // --- ì „ì—­ ìƒìˆ˜ ë° ë³€ìˆ˜ ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-gartic-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let userName = '';
        let roomRef = null;
        let roomId = null; // ë™ì ìœ¼ë¡œ í• ë‹¹ë¨

        // ìº”ë²„ìŠ¤ ê´€ë ¨ ë³€ìˆ˜
        let canvas, ctx;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentColor = '#000000';
        let currentBrushSize = 5;

        // --- DOM ìš”ì†Œ ì°¸ì¡° ---
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const initStatus = document.getElementById('initStatus');
        const roomSelectionView = document.getElementById('roomSelectionView'); // New
        const lobbyView = document.getElementById('lobbyView');
        const promptView = document.getElementById('promptView');
        const gameView = document.getElementById('gameView');
        const revealView = document.getElementById('revealView');

        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomIdInput = document.getElementById('joinRoomIdInput');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const roomIdDisplay = document.getElementById('roomIdDisplay');
        const roomLinkInput = document.getElementById('roomLinkInput');
        const copyLinkBtn = document.getElementById('copyLinkBtn');

        const userNameInput = document.getElementById('userNameInput');
        const setUserNameBtn = document.getElementById('setUserNameBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const initialPromptInput = document.getElementById('initialPromptInput');
        const submitPromptBtn = document.getElementById('submitPromptBtn');
        const clearCanvasBtn = document.getElementById('clearCanvasBtn');
        const submitDrawingBtn = document.getElementById('submitDrawingBtn');
        const submitGuessBtn = document.getElementById('submitGuessBtn');
        const colorPicker = document.getElementById('colorPicker');
        const brushSize = document.getElementById('brushSize');
        const newGameBtn = document.getElementById('newGameBtn');

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

        /**
         * URLì—ì„œ ë°© ID íŒŒë¼ë¯¸í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
         * @returns {string | null} ë°© ID ë¬¸ìì—´ ë˜ëŠ” null
         */
        function getRoomIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('room');
        }

        /**
         * ì„ì˜ì˜ ì§§ì€ ì˜ìˆ«ì ë°© IDë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
         * @returns {string} 6ìë¦¬ ë°© ID
         */
        function createUniqueRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        /**
         * ë©”ì‹œì§€ ë°•ìŠ¤ì— ìƒíƒœ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         * @param {string} msg - í‘œì‹œí•  ë©”ì‹œì§€
         * @param {string} type - 'error', 'info', 'success', 'warning' (ê¸°ë³¸ê°’: info)
         */
        function showMessage(msg, type = 'info') {
            const classes = {
                'info': 'bg-blue-100 border-blue-500 text-blue-700',
                'error': 'bg-red-100 border-red-500 text-red-700',
                'success': 'bg-green-100 border-green-500 text-green-700',
                'warning': 'bg-yellow-100 border-yellow-500 text-yellow-700',
            };
            messageBox.className = `p-4 rounded-lg shadow mb-6 border-l-4 ${classes[type]}`;
            messageText.textContent = msg;
            messageBox.classList.remove('hidden');
        }

        /**
         * í™”ë©´ ë·°ë¥¼ ì „í™˜í•©ë‹ˆë‹¤.
         * @param {string} viewId - í‘œì‹œí•  ë·°ì˜ ID ('select', 'lobby', 'prompt', 'game', 'reveal')
         */
        function showView(viewId) {
            roomSelectionView.classList.add('hidden'); // New
            lobbyView.classList.add('hidden');
            promptView.classList.add('hidden');
            gameView.classList.add('hidden');
            revealView.classList.add('hidden');

            switch (viewId) {
                case 'select': roomSelectionView.classList.remove('hidden'); break;
                case 'lobby': lobbyView.classList.remove('hidden'); break;
                case 'prompt': promptView.classList.remove('hidden'); break;
                case 'game': gameView.classList.remove('hidden'); break;
                case 'reveal': revealView.classList.remove('hidden'); break;
            }
        }

        /**
         * í˜„ì¬ ìº”ë²„ìŠ¤ ë‚´ìš©ì„ base64 ì´ë¯¸ì§€ URLë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
         */
        function getCanvasImage() {
            return canvas.toDataURL('image/png');
        }

        /**
         * base64 ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ìº”ë²„ìŠ¤ì— ë¡œë“œí•©ë‹ˆë‹¤.
         * @param {string} dataUrl - base64 ì´ë¯¸ì§€ ë°ì´í„° URL
         */
        function loadDrawingOnCanvas(dataUrl) {
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height); // ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê¸°
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = dataUrl;
        }


        // --- ìº”ë²„ìŠ¤ ë“œë¡œì‰ ë¡œì§ ---

        function setupCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');

            // ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ë¶€ëª¨ ìš”ì†Œì— ë§ì¶¥ë‹ˆë‹¤.
            const resizeCanvas = () => {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = Math.min(rect.width * 0.75, 500); // 4:3 ë¹„ìœ¨ ë˜ëŠ” ìµœëŒ€ 500px
            };

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            // ìº”ë²„ìŠ¤ ì„¤ì •
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                let clientX, clientY;

                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = currentBrushSize;
                ctx.stroke();
                [lastX, lastY] = [pos.x, pos.y];
            };

            const startDrawing = (e) => {
                e.preventDefault(); // ìŠ¤í¬ë¡¤/ì¤Œ ë°©ì§€ (í„°ì¹˜)
                isDrawing = true;
                const pos = getPos(e);
                [lastX, lastY] = [pos.x, pos.y];
            };

            const stopDrawing = () => {
                isDrawing = false;
            };

            // PC ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);

            // ìº”ë²„ìŠ¤ ì§€ìš°ê¸°
            clearCanvasBtn.addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });

            // ìƒ‰ìƒ ë° êµµê¸° ì„¤ì •
            colorPicker.addEventListener('input', (e) => {
                currentColor = e.target.value;
            });
            brushSize.addEventListener('input', (e) => {
                currentBrushSize = parseInt(e.target.value);
                document.getElementById('brushSizeDisplay').textContent = `${currentBrushSize}px`;
            });
        }


        // --- Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ---

        /**
         * Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
         */
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase ì„¤ì •ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // ì´ˆê¸° ì¸ì¦ ìƒíƒœ í™•ì¸
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = userId;
                        await loadUserData();
                        
                        initStatus.classList.add('hidden');
                        
                        // URLì—ì„œ ë°© ID í™•ì¸
                        const urlRoomId = getRoomIdFromUrl();

                        if (urlRoomId) {
                            roomId = urlRoomId;
                            showMessage(`ë°© ID ${roomId}ë¡œ ì ‘ì† ì‹œë„ ì¤‘...`, 'info');
                            setupRoomListener(); // ë°”ë¡œ ë¡œë¹„ë¡œ ì§„ì… ì‹œë„
                        } else {
                            // ë°© IDê°€ ì—†ìœ¼ë©´ ë°© ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™
                            showView('select');
                        }

                    } else {
                        // ì¸ì¦ í† í°ì´ ìˆìœ¼ë©´ ì»¤ìŠ¤í…€ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸, ì—†ìœ¼ë©´ ìµëª… ë¡œê·¸ì¸
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™”/ì¸ì¦ ì˜¤ë¥˜:", error);
                showMessage(`Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
                initStatus.classList.add('hidden');
            }
        }

        /**
         * Firestoreì—ì„œ ì‚¬ìš©ì ë‹‰ë„¤ì„ì„ ë¡œë“œí•˜ê±°ë‚˜ ì„¤ì •í•©ë‹ˆë‹¤.
         */
        async function loadUserData() {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/config`, 'profile');
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists()) {
                userName = docSnap.data().name || `ìµëª…_${userId.substring(0, 4)}`;
            } else {
                userName = `ìµëª…_${userId.substring(0, 4)}`;
                // ìƒˆ ì‚¬ìš©ìì´ë¯€ë¡œ Firestoreì— ê¸°ë³¸ ë‹‰ë„¤ì„ ì €ì¥
                await setDoc(userDocRef, { name: userName });
            }
            userNameInput.value = userName;
        }

        /**
         * ë°© ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•˜ê³  ë¡œë¹„ í™”ë©´ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.
         */
        function setupRoomListener() {
            if (!roomId || !db) {
                showMessage('ë°© ID ë˜ëŠ” Firebaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            // ë°© ì°¸ì¡° ì„¤ì •
            roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomId);
            roomIdDisplay.textContent = roomId;
            
            // ë§í¬ ìƒì„±
            const roomLink = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
            roomLinkInput.value = roomLink;

            showView('lobby');
            setupCanvas(); // ìº”ë²„ìŠ¤ ì´ˆê¸°í™” (ê²Œì„ ë·°ê°€ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ë¯¸ë¦¬ ì„¤ì •)

            onSnapshot(roomRef, async (docSnap) => {
                if (docSnap.exists()) {
                    await joinRoom(); // ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¼ë‹¨ ì°¸ì—¬ ì‹œë„
                    handleRoomUpdate(docSnap.data());
                } else {
                    // ë°©ì´ ì—†ìœ¼ë©´ ë°© ìƒì„± í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê±°ë‚˜,
                    // URLë¡œ ì ‘ì†í•œ ê²½ìš° ë°©ì¥ì—ê²Œ ë°© ìƒì„±ì„ ìš”ì²­í•©ë‹ˆë‹¤.
                    if (getRoomIdFromUrl() === roomId) {
                        showMessage('ì ‘ì†í•˜ë ¤ëŠ” ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•˜ê±°ë‚˜ IDë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'error');
                        showView('select');
                    } else {
                        // ìƒˆë¡œ ë§Œë“  ê²½ìš°ë§Œ ìë™ ìƒì„±
                        // ì´ë¯¸ lobbyViewì— ìˆìœ¼ë¯€ë¡œ, joinRoomì´ roomRefë¥¼ ë§Œë“¤ ë•Œê¹Œì§€ ëŒ€ê¸°
                    }
                }
            }, (error) => {
                console.error("Firestore ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
                showMessage("ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ì˜¤ë¥˜.", 'error');
                showView('select');
            });
        }

        /**
         * Firestore ë°© ë°ì´í„° ì—…ë°ì´íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê³  UIë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
         * @param {object} roomData - Firestoreì—ì„œ ë°›ì€ ë°© ë°ì´í„°
         */
        function handleRoomUpdate(roomData) {
            const { users = [], state, currentRound = 0, hostId, books = [] } = roomData;

            const isHost = hostId === userId;
            const currentUser = users.find(u => u.id === userId);
            const isReady = currentUser && currentUser.isReady;

            // 1. ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
            renderUserList(users, hostId);
            
            // ë°©ì¥ë§Œ ê²Œì„ ì‹œì‘ ê°€ëŠ¥
            startGameBtn.disabled = !isHost || users.length < 2 || users.some(u => !u.isReady); 
            startGameBtn.textContent = isHost ? "ê²Œì„ ì‹œì‘" : `ê²Œì„ ì‹œì‘ (${isHost ? 'ëŒ€ê¸° ì¤‘' : 'ë°©ì¥ ëŒ€ê¸° ì¤‘'})`;

            // 2. ê²Œì„ ìƒíƒœì— ë”°ë¥¸ ë·° ì „í™˜
            switch (state) {
                case 'lobby':
                    showView('lobby');
                    if (currentUser && !currentUser.isReady) {
                        showMessage('ë‹‰ë„¤ì„ì„ ì„¤ì •í•˜ê³  ì¤€ë¹„ ì™„ë£Œ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.', 'info');
                    } else if (currentUser && currentUser.isReady) {
                        showMessage('ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ë©´ ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.', 'info');
                    }
                    break;

                case 'prompt':
                    showView('prompt');
                    // ì´ë¯¸ í”„ë¡¬í”„íŠ¸ë¥¼ ì œì¶œí–ˆëŠ”ì§€ í™•ì¸
                    const hasSubmittedPrompt = books.some(b => b.starterId === userId);
                    if (hasSubmittedPrompt) {
                        submitPromptBtn.disabled = true;
                        submitPromptBtn.textContent = "ë¬¸ì¥ ì œì¶œ ì™„ë£Œ (ëŒ€ê¸° ì¤‘)";
                        initialPromptInput.disabled = true;
                        showMessage('ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ì´ ë¬¸ì¥ì„ ì œì¶œí•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì„¸ìš”.', 'info');
                    } else {
                        submitPromptBtn.disabled = initialPromptInput.value.trim().length === 0;
                        submitPromptBtn.textContent = "ë¬¸ì¥ ì œì¶œ";
                        initialPromptInput.disabled = false;
                        showMessage('ì²« ë¬¸ì¥ì„ ì…ë ¥í•˜ê³  ì œì¶œí•˜ì„¸ìš”.', 'info');
                    }
                    break;

                case 'drawing':
                case 'guessing':
                    showView('game');
                    handleGameTask(roomData); // ê²Œì„ í”Œë ˆì´ ë¡œì§ ì²˜ë¦¬
                    break;

                case 'reveal':
                    showView('reveal');
                    renderRevealView(books, users); // ê²°ê³¼ í™”ë©´ í‘œì‹œ
                    break;
            }
        }

        /**
         * ì‚¬ìš©ì ëª©ë¡ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
         * @param {Array<Object>} users - ì‚¬ìš©ì ê°ì²´ ë°°ì—´
         * @param {string} hostId - ë°©ì¥ ID
         */
        function renderUserList(users, hostId) {
            const userList = document.getElementById('userList');
            document.getElementById('userCount').textContent = users.length;
            userList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                const isMe = user.id === userId;
                const isHost = user.id === hostId;
                const statusIcon = user.isReady ? 'âœ…' : 'â³';
                const statusText = user.isReady ? 'ì¤€ë¹„ ì™„ë£Œ' : 'ì¤€ë¹„ ì¤‘';

                li.className = `p-2 rounded-lg flex justify-between items-center ${isMe ? 'bg-blue-50' : 'bg-white'}`;
                li.innerHTML = `
                    <span class="font-semibold">${user.name} ${isMe ? '(ë‚˜)' : ''} ${isHost ? 'ğŸ‘‘' : ''}</span>
                    <span class="text-sm text-gray-500">${statusIcon} ${statusText}</span>
                `;
                userList.appendChild(li);
            });
        }

        /**
         * í˜„ì¬ ë¼ìš´ë“œì˜ ê²Œì„ íƒœìŠ¤í¬ (ê·¸ë¦¼ ë˜ëŠ” ì¶”ì¸¡)ë¥¼ ì²˜ë¦¬í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         * @param {object} roomData - í˜„ì¬ ë°© ë°ì´í„°
         */
        function handleGameTask(roomData) {
            const { users, state, currentRound, books } = roomData;
            const userIds = users.map(u => u.id);
            const userIndex = userIds.indexOf(userId);

            if (userIndex === -1) {
                showMessage('ê²Œì„ì— ì°¸ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ë‚´ê°€ ë§¡ì•„ì•¼ í•  ì±… (Book)ì˜ ì¸ë±ìŠ¤ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
            const targetBookStarterIndex = (userIndex - currentRound + userIds.length) % userIds.length;
            const targetStarterId = userIds[targetBookStarterIndex];
            const targetBook = books.find(b => b.starterId === targetStarterId);

            if (!targetBook) {
                showMessage('í• ë‹¹ëœ ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ëª¨ë“  í”Œë ˆì´ì–´ê°€ í”„ë¡¬í”„íŠ¸ë¥¼ ì œì¶œí–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.)', 'warning');
                return;
            }

            const lastEntry = targetBook.chain[targetBook.chain.length - 1];
            const bookReady = targetBook.chain.length === currentRound + 1; // ë‚´ ì°¨ë¡€ê¹Œì§€ ì™„ë£Œëœ ìƒíƒœ

            document.getElementById('roundTitle').textContent = `${currentRound + 1} ë¼ìš´ë“œ: ${state === 'drawing' ? 'ê·¸ë¦¼ ê·¸ë¦¬ê¸°' : 'ì¶”ì¸¡í•˜ê¸°'}`;
            document.getElementById('taskDescription').innerHTML = `
                <p class="font-bold">ë‹¹ì‹ ì˜ ì±…: <span class="text-blue-600">${targetBook.starterName}</span>ë‹˜ì´ ì‹œì‘í•œ ì´ì•¼ê¸°</p>
                <p class="text-sm text-gray-500">í˜„ì¬ê¹Œì§€ ì§„í–‰: ${targetBook.chain.length} / ${users.length} ë‹¨ê³„</p>
            `;

            document.getElementById('drawingTask').classList.add('hidden');
            document.getElementById('guessingTask').classList.add('hidden');
            document.getElementById('waitingMessage').classList.add('hidden');

            if (bookReady) {
                // ì´ë¯¸ í˜„ì¬ ë¼ìš´ë“œ ì‘ì—…ì„ ì™„ë£Œí•¨ (ë‹¤ë¥¸ í”Œë ˆì´ì–´ ëŒ€ê¸°)
                document.getElementById('waitingMessage').classList.remove('hidden');
                showMessage('ì´ë²ˆ ë¼ìš´ë“œì˜ ì‘ì—…ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í”Œë ˆì´ì–´ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...', 'info');
                return;
            }

            // ë‚´ ì°¨ë¡€ ì‘ì—… ìˆ˜í–‰
            if (state === 'drawing') {
                // ì§ì „ í•­ëª©ì€ ë°˜ë“œì‹œ 'text'ì—¬ì•¼ í•©ë‹ˆë‹¤.
                if (lastEntry.type !== 'text') {
                    showMessage('ê²Œì„ ìƒíƒœ ì˜¤ë¥˜: ê·¸ë¦¼ì„ ê·¸ë ¤ì•¼ í•˜ëŠ”ë° ì´ì „ í•­ëª©ì´ í…ìŠ¤íŠ¸ê°€ ì•„ë‹™ë‹ˆë‹¤.', 'error');
                    return;
                }
                document.getElementById('drawingTask').classList.remove('hidden');
                document.getElementById('textToDraw').textContent = `"${lastEntry.content}"`;
                submitDrawingBtn.disabled = false;
                ctx.clearRect(0, 0, canvas.width, canvas.height); // ìƒˆ ê·¸ë¦¼ì„ ìœ„í•´ ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
                showMessage('ìœ„ì— ì œì‹œëœ ë¬¸ì¥ì„ ë³´ê³  ìº”ë²„ìŠ¤ì— ê·¸ë¦¼ì„ ê·¸ë¦¬ì„¸ìš”.', 'warning');

            } else if (state === 'guessing') {
                // ì§ì „ í•­ëª©ì€ ë°˜ë“œì‹œ 'drawing'ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
                if (lastEntry.type !== 'drawing') {
                    showMessage('ê²Œì„ ìƒíƒœ ì˜¤ë¥˜: ì¶”ì¸¡í•´ì•¼ í•˜ëŠ”ë° ì´ì „ í•­ëª©ì´ ê·¸ë¦¼ì´ ì•„ë‹™ë‹ˆë‹¤.', 'error');
                    return;
                }
                document.getElementById('guessingTask').classList.remove('hidden');
                loadDrawingOnCanvas(lastEntry.content);
                document.getElementById('imageToGuessContainer').classList.remove('hidden');
                submitGuessBtn.disabled = guessInput.value.trim().length === 0;
                showMessage('ì œì‹œëœ ê·¸ë¦¼ì„ ë³´ê³  ë¬´ì—‡ì¸ì§€ ì¶”ì¸¡í•˜ì—¬ ë¬¸ì¥ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
            }
        }

        /**
         * ê²°ê³¼ í™”ë©´ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
         * @param {Array<Object>} books - ìµœì¢… ê²°ê³¼ ì±… ë°°ì—´
         * @param {Array<Object>} users - ì‚¬ìš©ì ëª©ë¡
         */
        function renderRevealView(books, users) {
            const container = document.getElementById('revealContainer');
            container.innerHTML = '';

            books.forEach(book => {
                const starter = users.find(u => u.id === book.starterId) || { name: 'ì•Œ ìˆ˜ ì—†ìŒ' };
                const bookDiv = document.createElement('div');
                bookDiv.className = 'p-6 border-2 border-gray-200 rounded-xl shadow-lg';
                bookDiv.innerHTML = `<h3 class="text-2xl font-bold mb-4 text-purple-700">ğŸ“š ${starter.name}ë‹˜ì˜ ì±…: </h3>`;

                book.chain.forEach((entry, index) => {
                    const creator = users.find(u => u.id === entry.creatorId) || { name: 'ì•Œ ìˆ˜ ì—†ìŒ' };
                    const card = document.createElement('div');
                    card.className = 'step-card';

                    if (entry.type === 'text') {
                        card.innerHTML = `
                            <p class="font-semibold text-gray-700">Step ${index + 1}. ë¬¸ì¥ (by ${creator.name})</p>
                            <p class="text-xl mt-1 italic">"${entry.content}"</p>
                        `;
                    } else if (entry.type === 'drawing') {
                        card.innerHTML = `
                            <p class="font-semibold text-gray-700">Step ${index + 1}. ê·¸ë¦¼ (by ${creator.name})</p>
                            <img src="${entry.content}" alt="ê·¸ë¦¼ ${index}" class="mt-2 max-w-full h-auto rounded-lg border border-gray-300">
                        `;
                    }
                    bookDiv.appendChild(card);
                });
                container.appendChild(bookDiv);
            });
        }


        // --- Firestore ì•¡ì…˜ í•¨ìˆ˜ ---

        /**
         * ìƒˆë¡œìš´ ë°© IDë¡œ ë°©ì„ ìƒì„±í•©ë‹ˆë‹¤. (í˜¸ìŠ¤íŠ¸ ê¶Œí•œ)
         */
        async function createRoom(newRoomId) {
            if (!userId) {
                showMessage('ì‚¬ìš©ì IDê°€ ì—†ìŠµë‹ˆë‹¤. ì¸ì¦ ëŒ€ê¸° ì¤‘...', 'warning');
                return;
            }
            try {
                const tempRoomRef = doc(db, `artifacts/${appId}/public/data/rooms`, newRoomId);

                // ë°©ì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸ (íŠ¸ëœì­ì…˜ ë°–ì—ì„œ ê°€ë³ê²Œ í™•ì¸)
                const docSnap = await getDoc(tempRoomRef);
                if (docSnap.exists()) {
                    throw new Error("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°© IDì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
                }

                await setDoc(tempRoomRef, {
                    hostId: userId,
                    state: 'lobby', // ì´ˆê¸° ìƒíƒœ: ë¡œë¹„
                    currentRound: 0,
                    users: [],
                    books: [],
                    timestamp: Date.now()
                });
                
                // ë°© ìƒì„± í›„ í•´ë‹¹ ë°©ìœ¼ë¡œ ì´ë™ (URL ì—…ë°ì´íŠ¸)
                window.history.pushState({}, '', `?room=${newRoomId}`);
                roomId = newRoomId;
                showMessage(`ìƒˆë¡œìš´ ë°© ID ${roomId}ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                
                setupRoomListener(); // ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë° ì°¸ì—¬ ì‹œë„

            } catch (e) {
                console.error("ë°© ìƒì„± ì‹¤íŒ¨:", e);
                showMessage(`ë°© ìƒì„± ì‹¤íŒ¨: ${e.message}`, 'error');
                showView('select'); // ì‹¤íŒ¨ ì‹œ ë°© ì„ íƒ í™”ë©´ ìœ ì§€
            }
        }

        /**
         * ë°©ì— ì°¸ì—¬í•˜ê³  ì‚¬ìš©ì ëª©ë¡ì— ìì‹ ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
         */
        async function joinRoom() {
            if (!userId || !userName || !roomRef) return;

            const newUser = {
                id: userId,
                name: userName,
                isReady: false
            };

            // DBì— ë°©ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ë¦¬ìŠ¤ë„ˆê°€ ì²˜ë¦¬í•  ê²ƒì´ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸ë§Œ ì‹œë„)
            await runTransaction(db, async (transaction) => {
                const roomDoc = await transaction.get(roomRef);
                if (!roomDoc.exists()) {
                    // ë°©ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´, í˜„ì¬ ì‚¬ìš©ìê°€ URLë¡œ ì ‘ê·¼í–ˆê³  ë°©ì¥ì´ ì•„ë‹ˆë¯€ë¡œ ì°¸ì—¬ ë¶ˆê°€
                    // (ë¦¬ìŠ¤ë„ˆê°€ ì´ ìƒí™©ì„ ê°ì§€í•˜ê³  ì—ëŸ¬ ì²˜ë¦¬)
                    return; 
                }

                const data = roomDoc.data();
                const users = data.users || [];
                const existingUser = users.find(u => u.id === userId);

                if (!existingUser) {
                    transaction.update(roomRef, {
                        users: arrayUnion(newUser)
                    });
                } else if (existingUser.name !== userName) {
                    // ì´ë¦„ì´ ë°”ë€Œì—ˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                    const updatedUsers = users.map(u => u.id === userId ? { ...u, name: userName } : u);
                    transaction.update(roomRef, { users: updatedUsers });
                }
            }).catch(error => {
                console.error("ë°© ì°¸ì—¬/ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
            });
        }

        /**
         * ë‹‰ë„¤ì„ì„ ì—…ë°ì´íŠ¸í•˜ê³  ë°©ì— ì €ì¥í•©ë‹ˆë‹¤. (isReady ìƒíƒœë¥¼ trueë¡œ ë§Œë“­ë‹ˆë‹¤)
         */
        async function updateUserName() {
            const newName = userNameInput.value.trim();
            if (!newName) {
                showMessage('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            if (!roomId || !roomRef) {
                showMessage('ë¨¼ì € ë°©ì— ì°¸ì—¬í•˜ê±°ë‚˜ ë°©ì„ ë§Œë“œì„¸ìš”.', 'error');
                return;
            }

            userName = newName;
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/config`, 'profile');
            await setDoc(userDocRef, { name: userName }); // ë¡œì»¬ í”„ë¡œí•„ ì—…ë°ì´íŠ¸

            // ë°©ì˜ ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸ (isReady ìƒíƒœë¥¼ trueë¡œ ì „í™˜)
            await runTransaction(db, async (transaction) => {
                const roomDoc = await transaction.get(roomRef);
                if (!roomDoc.exists()) throw "Room does not exist!";

                const data = roomDoc.data();
                const users = data.users || [];
                const updatedUsers = users.map(u =>
                    u.id === userId ? { ...u, name: userName, isReady: true } : u
                );
                // ë°©ì— ì—†ëŠ” ì‚¬ìš©ìë¼ë©´ (ì•„ì£¼ ë“œë¬¸ ê²½ìš°) ì¶”ê°€
                if (!users.some(u => u.id === userId)) {
                    updatedUsers.push({ id: userId, name: userName, isReady: true });
                }

                transaction.update(roomRef, { users: updatedUsers });
            }).then(() => {
                showMessage(`ë‹‰ë„¤ì„ì´ ${userName}ìœ¼ë¡œ ì €ì¥ë˜ì—ˆê³  ì¤€ë¹„ ì™„ë£Œ ìƒíƒœì…ë‹ˆë‹¤.`, 'success');
            }).catch(error => {
                console.error("ë‹‰ë„¤ì„ ì—…ë°ì´íŠ¸/ì¤€ë¹„ ìƒíƒœ ì‹¤íŒ¨:", error);
                showMessage("ë‹‰ë„¤ì„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'error');
            });
        }

        /**
         * í˜¸ìŠ¤íŠ¸ê°€ ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.
         */
        async function startGame() {
            await runTransaction(db, async (transaction) => {
                const roomDoc = await transaction.get(roomRef);
                if (!roomDoc.exists()) throw "Room does not exist!";

                const data = roomDoc.data();
                if (data.hostId !== userId) throw "Not the host!";
                if (data.users.length < 2) throw "Need at least 2 players!";

                transaction.update(roomRef, {
                    state: 'prompt', // 1ë‹¨ê³„: í”„ë¡¬í”„íŠ¸ ì…ë ¥
                    currentRound: 0,
                    books: [] // ê¸°ì¡´ ì±… ì´ˆê¸°í™”
                });
            }).catch(error => {
                console.error("ê²Œì„ ì‹œì‘ ì‹¤íŒ¨:", error);
                showMessage(`ê²Œì„ ì‹œì‘ ì‹¤íŒ¨: ${error.message}`, 'error');
            });
        }

        /**
         * ì‚¬ìš©ìì˜ ì´ˆê¸° í”„ë¡¬í”„íŠ¸ë¥¼ ì œì¶œí•©ë‹ˆë‹¤.
         */
        async function submitInitialPrompt() {
            const prompt = initialPromptInput.value.trim();
            if (!prompt) return;

            const bookEntry = {
                starterId: userId,
                starterName: userName,
                chain: [{
                    round: 0,
                    type: 'text',
                    content: prompt,
                    creatorId: userId
                }]
            };

            await runTransaction(db, async (transaction) => {
                const roomDoc = await transaction.get(roomRef);
                if (!roomDoc.exists()) throw "Room does not exist!";

                const data = roomDoc.data();
                if (data.state !== 'prompt') throw "ê²Œì„ ìƒíƒœê°€ 'prompt'ê°€ ì•„ë‹™ë‹ˆë‹¤.";

                // ì´ë¯¸ ì œì¶œí–ˆëŠ”ì§€ ë‹¤ì‹œ í™•ì¸
                if (data.books.some(b => b.starterId === userId)) throw "ì´ë¯¸ ë¬¸ì¥ì„ ì œì¶œí–ˆìŠµë‹ˆë‹¤.";

                // íŠ¸ëœì­ì…˜ì—ì„œ ë°°ì—´ ì—…ë°ì´íŠ¸
                const newBooks = [...data.books, bookEntry];
                
                // ëª¨ë“  í”Œë ˆì´ì–´ê°€ í”„ë¡¬í”„íŠ¸ë¥¼ ì œì¶œí–ˆëŠ”ì§€ í™•ì¸
                const allSubmitted = newBooks.length === data.users.length;
                
                const updatePayload = {
                    books: newBooks
                };
                
                if (allSubmitted) {
                    updatePayload.currentRound = 1;
                    updatePayload.state = 'drawing'; // ë‹¤ìŒ ë¼ìš´ë“œëŠ” ê·¸ë¦¼ ê·¸ë¦¬ê¸°
                }

                transaction.update(roomRef, updatePayload);
            }).then(() => {
                showMessage('ë¬¸ì¥ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.', 'success');
                submitPromptBtn.disabled = true;
                submitPromptBtn.textContent = "ë¬¸ì¥ ì œì¶œ ì™„ë£Œ (ëŒ€ê¸° ì¤‘)";
                initialPromptInput.disabled = true;
            }).catch(error => {
                console.error("í”„ë¡¬í”„íŠ¸ ì œì¶œ ì‹¤íŒ¨:", error);
                showMessage(`í”„ë¡¬í”„íŠ¸ ì œì¶œ ì‹¤íŒ¨: ${error.message}`, 'error');
            });
        }


        /**
         * ë¼ìš´ë“œ ì‘ì—…ì„ ì œì¶œí•©ë‹ˆë‹¤ (ê·¸ë¦¼ ë˜ëŠ” ì¶”ì¸¡).
         * @param {string} type - 'drawing' ë˜ëŠ” 'guessing'
         * @param {string} content - ê·¸ë¦¼(base64) ë˜ëŠ” ì¶”ì¸¡ ë¬¸ì¥
         */
        async function submitRoundTask(type, content) {
            if (!content || !roomRef) return;

            await runTransaction(db, async (transaction) => {
                const roomDoc = await transaction.get(roomRef);
                if (!roomDoc.exists()) throw "Room does not exist!";

                const data = roomDoc.data();
                const { users, currentRound, books } = data;
                const userIds = users.map(u => u.id);
                const userIndex = userIds.indexOf(userId);

                if (userIndex === -1) throw "ë°©ì— ì°¸ì—¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";

                // í• ë‹¹ëœ ì±… ì°¾ê¸° (ì±…ì€ currentRoundë§Œí¼ ì¸ë±ìŠ¤ê°€ ë°€ë¦½ë‹ˆë‹¤)
                const targetBookStarterIndex = (userIndex - currentRound + userIds.length) % userIds.length;
                const targetStarterId = userIds[targetBookStarterIndex];

                const bookIndex = books.findIndex(b => b.starterId === targetStarterId);
                if (bookIndex === -1) throw "í• ë‹¹ëœ ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

                const targetBook = books[bookIndex];

                // ì œì¶œëœ í•­ëª©ì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸ (currentRound + 1ì€ í˜„ì¬ ì±…ì˜ ì²´ì¸ ê¸¸ì´)
                if (targetBook.chain.length === currentRound + 1) throw "ì´ë¯¸ ì´ ë¼ìš´ë“œë¥¼ ì œì¶œí–ˆìŠµë‹ˆë‹¤.";

                const newEntry = {
                    round: currentRound + 1,
                    type: type,
                    content: content,
                    creatorId: userId,
                    basedOnRound: currentRound
                };

                // ìƒˆ ì²´ì¸ í•­ëª© ì¶”ê°€
                targetBook.chain.push(newEntry);

                // ì „ì²´ ì œì¶œ ì™„ë£Œ í™•ì¸
                const allSubmitted = books.every((b, i) => (i === bookIndex ? targetBook : b).chain.length === currentRound + 2); // ë‚´ê°€ ì œì¶œí•œ í•­ëª©ì´ í¬í•¨ë˜ì–´ ì²´ì¸ ê¸¸ì´ê°€ currentRound + 2ê°€ ë¨

                const updatePayload = {
                    books: books.map((b, i) => i === bookIndex ? targetBook : b)
                };

                // ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì œì¶œí–ˆìœ¼ë©´ ë‹¤ìŒ ë¼ìš´ë“œë¡œ ì§„í–‰
                if (allSubmitted) {
                    const nextRound = currentRound + 1;
                    const totalSteps = users.length; // ì´ ë¼ìš´ë“œ ìˆ˜ (í”„ë¡¬í”„íŠ¸ í¬í•¨ ì´ ë‹¨ê³„ ìˆ˜)

                    if (nextRound === totalSteps) {
                        // ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ -> ê²°ê³¼ ë°œí‘œ
                        updatePayload.state = 'reveal';
                    } else {
                        updatePayload.currentRound = nextRound;
                        // ë¼ìš´ë“œ 0: text, ë¼ìš´ë“œ 1: drawing, ë¼ìš´ë“œ 2: guessing, ë¼ìš´ë“œ 3: drawing...
                        // í˜„ì¬ ë¼ìš´ë“œê°€ í™€ìˆ˜(1, 3, 5...)ë©´ ë‹¤ìŒì€ 'guessing' (í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥)
                        // í˜„ì¬ ë¼ìš´ë“œê°€ ì§ìˆ˜(2, 4, 6...)ë©´ ë‹¤ìŒì€ 'drawing' (ê·¸ë¦¼ì„ ì…ë ¥)
                        // í”„ë¡¬í”„íŠ¸ëŠ” ë¼ìš´ë“œ 0, í…ìŠ¤íŠ¸ê°€ ë“¤ì–´ìˆìŒ.
                        // ë¼ìš´ë“œ 1 (í˜„ì¬): type drawing -> ë‹¤ìŒì€ guessing
                        // ë¼ìš´ë“œ 2 (í˜„ì¬): type guessing -> ë‹¤ìŒì€ drawing
                        const nextState = (nextRound % 2 === 1) ? 'guessing' : 'drawing';
                        updatePayload.state = nextState;
                    }
                }

                transaction.update(roomRef, updatePayload);

            }).then(() => {
                showMessage('ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¥¼ ê¸°ë‹¤ë¦¬ì„¸ìš”.', 'success');
            }).catch(error => {
                console.error("ë¼ìš´ë“œ ì‘ì—… ì œì¶œ ì‹¤íŒ¨:", error);
                showMessage(`ì œì¶œ ì‹¤íŒ¨: ${error.message}`, 'error');
            });
        }

        /**
         * ê²Œì„ì„ ì´ˆê¸°í™”í•˜ê³  ë¡œë¹„ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤. (í˜¸ìŠ¤íŠ¸ ì „ìš©)
         */
        async function startNewGame() {
             await runTransaction(db, async (transaction) => {
                const roomDoc = await transaction.get(roomRef);
                if (!roomDoc.exists()) throw "Room does not exist!";

                const data = roomDoc.data();
                if (data.hostId !== userId) throw "Not the host!";

                // ëª¨ë“  ì‚¬ìš©ìì˜ isReadyë¥¼ falseë¡œ ì´ˆê¸°í™”
                const resetUsers = data.users.map(u => ({...u, isReady: false}));

                transaction.update(roomRef, {
                    state: 'lobby',
                    currentRound: 0,
                    books: [],
                    users: resetUsers // ì‚¬ìš©ì ëª©ë¡ ì´ˆê¸°í™”
                });
            }).then(() => {
                showMessage('ê²Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œë¹„ì—ì„œ ë‹¤ì‹œ ì¤€ë¹„í•˜ì„¸ìš”.', 'info');
            }).catch(error => {
                console.error("ê²Œì„ ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                showMessage(`ê²Œì„ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            });
        }
        
        // --- ìƒˆë¡œìš´ ê¸°ëŠ¥ ê´€ë ¨ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
        
        /**
         * ìƒˆë¡œìš´ ë°©ì„ ë§Œë“¤ê³  í•´ë‹¹ ë°©ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.
         */
        function handleCreateRoom() {
            const newRoomId = createUniqueRoomId();
            createRoom(newRoomId);
        }

        /**
         * ì…ë ¥ëœ ë°© IDë¡œ ì°¸ì—¬ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.
         */
        function handleJoinRoom() {
            const inputId = joinRoomIdInput.value.trim().toUpperCase();
            if (!inputId) {
                showMessage('ë°© IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            // URLì„ ì—…ë°ì´íŠ¸í•˜ì—¬ ë¦¬ìŠ¤ë„ˆê°€ ìƒˆ ë°©ìœ¼ë¡œ ì´ë™í•˜ë„ë¡ íŠ¸ë¦¬ê±°
            window.history.pushState({}, '', `?room=${inputId}`);
            roomId = inputId;
            showMessage(`ë°© ID ${roomId}ë¡œ ì ‘ì† ì‹œë„ ì¤‘...`, 'info');
            setupRoomListener();
        }

        /**
         * ì°¸ì—¬ ë§í¬ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í•©ë‹ˆë‹¤.
         */
        function copyLinkToClipboard() {
            const link = roomLinkInput.value;
            // execCommandëŠ” ë³´ì•ˆ ì œì•½ìœ¼ë¡œ ì¸í•´ navigator.clipboard ëŒ€ì‹  ì‚¬ìš©
            try {
                const tempInput = document.createElement('input');
                tempInput.value = link;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showMessage('ğŸ”— ì°¸ì—¬ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                showMessage('ë§í¬ ë³µì‚¬ ì‹¤íŒ¨: ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.', 'error');
            }
        }


        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---

        window.onload = initializeFirebase;

        // ë°© ì„ íƒ ë·° ì´ë²¤íŠ¸
        createRoomBtn.addEventListener('click', handleCreateRoom);
        joinRoomBtn.addEventListener('click', handleJoinRoom);
        joinRoomIdInput.addEventListener('input', (e) => {
            joinRoomBtn.disabled = e.target.value.trim().length === 0;
            e.target.value = e.target.value.toUpperCase(); // ë°© IDëŠ” ëŒ€ë¬¸ìë¡œ í†µì¼
        });
        
        // ë¡œë¹„ ë·° ì´ë²¤íŠ¸
        copyLinkBtn.addEventListener('click', copyLinkToClipboard);
        setUserNameBtn.addEventListener('click', updateUserName);
        startGameBtn.addEventListener('click', startGame);

        // ê²Œì„ ë·° ì´ë²¤íŠ¸
        initialPromptInput.addEventListener('input', (e) => {
            submitPromptBtn.disabled = e.target.value.trim().length === 0;
        });
        submitPromptBtn.addEventListener('click', submitInitialPrompt);

        submitDrawingBtn.addEventListener('click', () => {
            const drawingDataUrl = getCanvasImage();
            submitRoundTask('text', drawingDataUrl); // ê·¸ë¦¼ ì œì¶œ ë‹¤ìŒ ë‹¨ê³„ëŠ” 'text' íƒ€ì…ì˜ ì¶”ì¸¡
        });

        guessInput.addEventListener('input', (e) => {
            submitGuessBtn.disabled = e.target.value.trim().length === 0;
        });
        submitGuessBtn.addEventListener('click', () => {
            const guess = guessInput.value.trim();
            submitRoundTask('drawing', guess); // ì¶”ì¸¡ ì œì¶œ ë‹¤ìŒ ë‹¨ê³„ëŠ” 'drawing' íƒ€ì…ì˜ ê·¸ë¦¼
            guessInput.value = ''; // ì œì¶œ í›„ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        });

        newGameBtn.addEventListener('click', startNewGame);
    </script>
</body>
</html>